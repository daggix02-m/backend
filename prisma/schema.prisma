// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
  output   = "../node_modules/.prisma/client"
}

datasource db {
  provider = "postgresql"
}

// ============================================
// 1. MULTI-TENANT STRUCTURE
// ============================================

model Pharmacy {
  id             Int       @id @default(autoincrement())
  name           String    @db.VarChar(200)
  email          String?   @db.VarChar(150)
  phone          String?   @db.VarChar(30)
  licenseNumber  String?   @map("license_number") @db.VarChar(100)
  address        String?   @db.Text
  tin            String?   @db.VarChar(50)
  logoUrl        String?   @map("logo_url") @db.VarChar(500)
  website        String?   @db.VarChar(255)
  createdAt      DateTime  @default(now()) @map("created_at")
  updatedAt      DateTime  @updatedAt @map("updated_at")

  branches Branch[]
  users    User[]

  @@map("pharmacies")
}

model Branch {
  id          Int       @id @default(autoincrement())
  pharmacyId  Int       @map("pharmacy_id")
  name        String    @db.VarChar(150)
  location    String    @db.Text
  phone       String?   @db.VarChar(20)
  email       String?   @db.VarChar(150)
  isMainBranch Boolean   @default(false) @map("is_main_branch")
  isActive    Boolean   @default(true) @map("is_active")
  status      String    @default("active") @db.VarChar(20)
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  pharmacy     Pharmacy     @relation(fields: [pharmacyId], references: [id], onDelete: Cascade)
  medicines    Medicine[]
  stocks       Stock[]
  sales        Sale[]
  cashierShifts CashierShift[]
  userBranches UserBranch[]

  @@index([pharmacyId])
  @@map("branches")
}

// ============================================
// 2. USERS & ROLES
// ============================================

model Role {
  id   Int    @id @default(autoincrement())
  name String @unique @db.VarChar(50)

  userRoles UserRole[]

  @@map("roles")
}

model User {
  id                Int       @id @default(autoincrement())
  pharmacyId        Int       @map("pharmacy_id")
  fullName          String    @map("full_name") @db.VarChar(150)
  email             String    @unique @db.VarChar(150)
  passwordHash      String    @map("password_hash") @db.Text
  isActive          Boolean   @default(false) @map("is_active")
  mustChangePassword Boolean @default(true) @map("must_change_password")
  createdAt         DateTime  @default(now()) @map("created_at")

  pharmacy    Pharmacy       @relation(fields: [pharmacyId], references: [id], onDelete: Cascade)
  userRoles   UserRole[]
  userBranches UserBranch[]
  salesAsPharmacist Sale[] @relation("SalePharmacist")
  salesAsCashier   Sale[] @relation("SaleCashier")
  refunds          Refund[]
  cashierShifts    CashierShift[]

  @@index([pharmacyId])
  @@index([email])
  @@map("users")
}

model UserRole {
  userId  Int @map("user_id")
  roleId  Int @map("role_id")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  role Role @relation(fields: [roleId], references: [id])

  @@id([userId, roleId])
  @@map("user_roles")
}

model UserBranch {
  userId   Int @map("user_id")
  branchId Int @map("branch_id")

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  branch Branch @relation(fields: [branchId], references: [id], onDelete: Cascade)

  @@id([userId, branchId])
  @@map("user_branches")
}

// ============================================
// 3. INVENTORY
// ============================================

model MedicineCategory {
  id        Int       @id @default(autoincrement())
  name      String    @db.VarChar(100)
  createdAt DateTime  @default(now()) @map("created_at")

  medicines Medicine[]

  @@map("medicine_categories")
}

model Medicine {
  id                  Int              @id @default(autoincrement())
  branchId            Int              @map("branch_id")
  name                String            @db.VarChar(200)
  genericName         String?           @map("generic_name") @db.VarChar(200)
  brandName           String?           @map("brand_name") @db.VarChar(200)
  categoryId          Int?              @map("category_id")
  sku                 String?           @db.VarChar(100)
  unitPrice           Decimal           @map("unit_price") @db.Decimal(10, 2)
  unitType            String?           @map("unit_type") @db.VarChar(50)
  strength            String?           @db.VarChar(100)
  manufacturer        String?           @db.VarChar(200)
  description         String?           @db.Text
  minStockLevel       Int               @default(0) @map("min_stock_level")
  requiresPrescription Boolean           @default(false) @map("requires_prescription")
  isDeleted           Boolean           @default(false) @map("is_deleted")
  createdAt           DateTime          @default(now()) @map("created_at")
  updatedAt           DateTime          @updatedAt @map("updated_at")

  branch   Branch            @relation(fields: [branchId], references: [id], onDelete: Cascade)
  category MedicineCategory? @relation(fields: [categoryId], references: [id])
  batches  MedicineBatch[]
  movements StockMovement[]
  stocks   Stock[]

  @@index([branchId])
  @@index([categoryId])
  @@index([sku])
  @@map("medicines")
}

model MedicineBatch {
  id             Int      @id @default(autoincrement())
  medicineId     Int      @map("medicine_id")
  batchNumber    String   @unique @map("batch_number") @db.VarChar(100)
  expiryDate     DateTime @map("expiry_date") @db.Date
  quantity       Int
  costPrice      Decimal?  @map("cost_price") @db.Decimal(10, 2)
  sellingPrice   Decimal?  @map("selling_price") @db.Decimal(10, 2)
  createdAt      DateTime @default(now()) @map("created_at")

  medicine  Medicine   @relation(fields: [medicineId], references: [id], onDelete: Cascade)
  saleItems SaleItem[]
  movements StockMovement[]

  @@unique([medicineId, batchNumber])
  @@index([medicineId])
  @@index([expiryDate])
  @@map("medicine_batches")
}

model StockMovement {
  id             Int      @id @default(autoincrement())
  medicineId     Int      @map("medicine_id")
  batchId        Int?     @map("batch_id")
  branchId       Int      @map("branch_id")
  userId         Int?     @map("user_id")
  type           String   @db.VarChar(20)
  quantity       Int
  reason         String?  @db.Text
  referenceId    String?  @map("reference_id")
  targetBranchId Int?     @map("target_branch_id")
  createdAt      DateTime @default(now()) @map("created_at")

  medicine Medicine       @relation(fields: [medicineId], references: [id])
  batch    MedicineBatch? @relation(fields: [batchId], references: [id])

  @@index([medicineId])
  @@index([branchId])
  @@index([type])
  @@map("stock_movements")
}

model Stock {
  id             Int      @id @default(autoincrement())
  medicineId     Int      @map("medicine_id")
  branchId       Int      @map("branch_id")
  quantity       Int      @default(0)
  lastRestocked   DateTime? @map("last_restocked")
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  medicine Medicine @relation(fields: [medicineId], references: [id], onDelete: Cascade)
  branch   Branch   @relation(fields: [branchId], references: [id], onDelete: Cascade)

  @@unique([medicineId, branchId])
  @@index([medicineId])
  @@index([branchId])
  @@map("stocks")
}

// ============================================
// 4. PAYMENTS
// ============================================

model PaymentMethod {
  id   Int    @id @default(autoincrement())
  name String @unique @db.VarChar(50)

  payments Payment[]

  @@map("payment_methods")
}

// ============================================
// 5. CASHIER SHIFTS
// ============================================

model CashierShift {
  id             Int       @id @default(autoincrement())
  userId         Int       @map("user_id")
  branchId       Int       @map("branch_id")
  startTime      DateTime  @map("start_time")
  endTime        DateTime?  @map("end_time")
  openingBalance Decimal?  @map("opening_balance") @db.Decimal(12, 2)
  closingBalance Decimal?  @map("closing_balance") @db.Decimal(12, 2)
  actualSales    Decimal?  @map("actual_sales") @db.Decimal(12, 2)
  status         String    @default("OPEN") @db.VarChar(20)
  notes          String?   @db.Text
  openedAt       DateTime  @default(now()) @map("opened_at")
  closedAt       DateTime? @map("closed_at")

  user   User    @relation(fields: [userId], references: [id])
  branch Branch  @relation(fields: [branchId], references: [id])
  sales  Sale[]

  @@index([userId])
  @@index([branchId])
  @@index([status])
  @@map("cashier_shifts")
}

// ============================================
// 6. SALES
// ============================================

model Sale {
  id             Int       @id @default(autoincrement())
  pharmacyId     Int       @map("pharmacy_id")
  branchId       Int       @map("branch_id")
  pharmacistId   Int       @map("pharmacist_id")
  cashierId      Int?      @map("cashier_id")
  shiftId        Int?      @map("shift_id")
  userId         Int?      @map("user_id")
  customerName   String?   @map("customer_name") @db.VarChar(200)
  customerPhone  String?   @map("customer_phone") @db.VarChar(30)
  status         String    @default("pending_payment") @db.VarChar(30)
  subtotal        Decimal   @db.Decimal(12, 2)
  vatAmount      Decimal   @map("vat_amount") @db.Decimal(12, 2)
  discountAmount Decimal?  @map("discount_amount") @db.Decimal(12, 2)
  taxAmount      Decimal?  @map("tax_amount") @db.Decimal(12, 2)
  totalAmount    Decimal   @map("total_amount") @db.Decimal(12, 2)
  finalAmount    Decimal   @map("final_amount") @db.Decimal(12, 2)
  paymentMethodId Int?     @map("payment_method_id")
  createdAt      DateTime  @default(now()) @map("created_at")
  updatedAt      DateTime  @updatedAt @map("updated_at")

  branch     Branch        @relation(fields: [branchId], references: [id])
  pharmacist User          @relation("SalePharmacist", fields: [pharmacistId], references: [id])
  cashier    User?         @relation("SaleCashier", fields: [cashierId], references: [id])
  shift      CashierShift? @relation(fields: [shiftId], references: [id])
  items      SaleItem[]
  payments   Payment[]
  refunds    Refund[]

  @@index([branchId])
  @@index([pharmacyId])
  @@index([pharmacistId])
  @@index([cashierId])
  @@index([userId])
  @@index([shiftId])
  @@index([status])
  @@map("sales")
}

model SaleItem {
  id          Int      @id @default(autoincrement())
  saleId      Int      @map("sale_id")
  medicineId  Int?     @map("medicine_id")
  batchId     Int?     @map("batch_id")
  quantity    Int
  unitPrice   Decimal  @map("unit_price") @db.Decimal(10, 2)
  vatAmount   Decimal  @map("vat_amount") @db.Decimal(12, 2)
  subtotal    Decimal  @db.Decimal(12, 2)
  totalPrice  Decimal  @map("total_price") @db.Decimal(12, 2)

  sale     Sale          @relation(fields: [saleId], references: [id], onDelete: Cascade)
  batch    MedicineBatch? @relation(fields: [batchId], references: [id])
  refunds  RefundItem[]

  @@index([saleId])
  @@index([batchId])
  @@index([medicineId])
  @@map("sale_items")
}

// ============================================
// 7. PAYMENTS
// ============================================

model Payment {
  id             Int      @id @default(autoincrement())
  saleId         Int      @map("sale_id")
  paymentMethodId Int      @map("payment_method_id")
  amount         Decimal  @db.Decimal(12, 2)
  status         String   @default("pending") @db.VarChar(30)
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  sale          Sale              @relation(fields: [saleId], references: [id], onDelete: Cascade)
  paymentMethod PaymentMethod     @relation(fields: [paymentMethodId], references: [id])
  transactions  PaymentTransaction[]

  @@index([saleId])
  @@index([paymentMethodId])
  @@index([status])
  @@map("payments")
}

model PaymentTransaction {
  id                    Int      @id @default(autoincrement())
  paymentId             Int      @map("payment_id")
  provider              String   @db.VarChar(50)
  txRef                 String   @unique @map("tx_ref") @db.VarChar(150)
  providerTransactionId String?  @map("provider_transaction_id") @db.VarChar(150)
  rawResponse           Json?    @map("raw_response")
  verified              Boolean  @default(false)
  createdAt             DateTime @default(now()) @map("created_at")

  payment Payment @relation(fields: [paymentId], references: [id], onDelete: Cascade)

  @@index([paymentId])
  @@index([txRef])
  @@index([provider])
  @@map("payment_transactions")
}

// ============================================
// 8. REFUNDS
// ============================================

model Refund {
  id          Int      @id @default(autoincrement())
  saleId      Int      @map("sale_id")
  pharmacyId  Int      @map("pharmacy_id")
  branchId    Int      @map("branch_id")
  userId      Int      @map("user_id")
  processedBy Int      @map("processed_by")
  reason      String?  @db.Text
  refundAmount Decimal  @map("refund_amount") @db.Decimal(12, 2)
  totalAmount Decimal  @map("total_amount") @db.Decimal(12, 2)
  status      String    @default("COMPLETED") @db.VarChar(30)
  createdAt   DateTime @default(now()) @map("created_at")

  sale     Sale        @relation(fields: [saleId], references: [id])
  user     User        @relation(fields: [processedBy], references: [id])
  items    RefundItem[]

  @@index([saleId])
  @@index([pharmacyId])
  @@index([branchId])
  @@index([userId])
  @@index([processedBy])
  @@map("refunds")
}

model RefundItem {
  id         Int      @id @default(autoincrement())
  refundId   Int      @map("refund_id")
  saleItemId Int      @map("sale_item_id")
  medicineId Int?     @map("medicine_id")
  quantity   Int
  unitPrice  Decimal  @map("unit_price") @db.Decimal(10, 2)
  totalPrice Decimal  @map("total_price") @db.Decimal(12, 2)

  refund    Refund    @relation(fields: [refundId], references: [id], onDelete: Cascade)
  saleItem  SaleItem  @relation(fields: [saleItemId], references: [id])

  @@index([refundId])
  @@index([saleItemId])
  @@map("refund_items")
}
